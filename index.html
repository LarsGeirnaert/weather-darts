<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weer Spelletjes Hub</title>
    <!-- Load Tailwind CSS voor snelle, responsieve styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font voor een speelse look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f7; /* Lichtblauwe, koele achtergrond */
            background-image: radial-gradient(#d1edf4 1px, transparent 1px), radial-gradient(#d1edf4 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        .container-card {
            background: linear-gradient(135deg, #ffffff 0%, #f7f9fa 100%);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 550px;
            border-radius: 1.5rem; /* Meer afgerond */
        }
        .button-primary {
            background-color: #0d9488; /* Teal kleur, thematisch */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 6px #0f766e;
            transform: translateY(0);
        }
        .button-primary:hover {
            background-color: #0f766e;
        }
        .button-primary:active {
            box-shadow: 0 2px #0f766e;
            transform: translateY(4px);
        }
        .menu-button {
            padding: 1.2rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 800;
            transition: all 0.2s;
            box-shadow: 0 8px #a855f7; /* Paarse schaduw voor contrast */
            background-color: #c084fc;
        }
        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px #a855f7;
        }
        .score-panel {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        /* Nieuwe stijl voor de kaart */
        #world-map-canvas {
            border: 4px solid #1d4ed8;
            border-radius: 10px;
            cursor: crosshair;
            background-color: #a0c4ff; /* Lichte oceaan kleur */
            width: 100%;
            display: block;
            margin: 0 auto;
        }
        .map-wrapper {
            position: relative;
            /* 2:1 aspect ratio voor een wereldkaart */
            padding-bottom: 50%; 
            height: 0;
            overflow: hidden;
            border-radius: 10px;
        }
        .map-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Stijl voor de geschiedenis (scrollable) */
        #history-log-container {
            max-height: 250px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- MAIN MENU VIEW -->
    <div id="main-menu" class="container-card w-full p-8 rounded-3xl border border-gray-100 text-center">
        <h1 class="text-5xl font-black text-gray-900 mb-8 tracking-tight">
            Weer Spelletjes Hub
        </h1>
        <p class="text-xl text-gray-600 mb-10">Kies een spel om te starten:</p>

        <div class="space-y-6">
            <!-- Game 1 Button -->
            <button id="startGameButton" onclick="checkApiAndStart('deduction')" class="menu-button w-full text-white disabled:bg-gray-400 disabled:shadow-none disabled:transform-none">
                <span class="mr-2">üå°Ô∏è</span> 1. Temperatuur Aftrek Spel
            </button>
            <!-- Game 2 Button -->
            <button id="startGameGuessButton" onclick="checkApiAndStart('guessing')" class="menu-button w-full text-white disabled:bg-gray-400 disabled:shadow-none disabled:transform-none">
                <span class="mr-2">üé≤</span> 2. Temperatuur Raden
            </button>
        </div>

        <!-- API Status / Laadindicator -->
        <div id="status-message" class="text-center p-3 mt-10 rounded-lg font-semibold bg-gray-100 text-gray-600">
            Initialiseren...
        </div>
    </div>

    <!-- GAME VIEW - CONTAINER FOR BOTH GAMES -->
    <div id="game-container" class="container-card w-full p-8 rounded-3xl border border-gray-100 hidden">
        
        <button onclick="showView('menu')" class="mb-6 text-blue-600 hover:text-blue-800 font-bold flex items-center transition-colors">
            <span class="text-2xl mr-2">‚óÄ</span> Terug naar Hoofdmenu
        </button>

        <!-- Game 1: Temperatuur Aftrek Spel -->
        <div id="deduction-game" class="hidden">
            <h1 class="text-4xl font-black text-center text-gray-900 mb-8">
                Temperatuur Aftrek Spel
            </h1>
            
            <div id="deduction-game-board" class="space-y-6 hidden">
                
                <div class="p-4 bg-amber-50 rounded-xl border-2 border-amber-300 text-center shadow-inner">
                    <p class="text-base font-medium text-amber-800 flex items-center justify-center">
                        <span class="mr-2 text-xl">üéØ</span> DOEL: Eindig na 5 beurten zo dicht mogelijk bij 0¬∞C.
                    </p>
                    <p id="deduction-guess-warning" class="text-sm mt-1 font-bold text-red-600">
                        LET OP: Je mag elke locatie maar √â√âN KEER gokken!
                    </p>
                </div>

                <!-- Score Display -->
                <div class="score-panel flex justify-between items-center p-6 text-white rounded-xl shadow-2xl transition duration-300">
                    <div>
                        <p class="text-lg font-medium opacity-80">Nog af te trekken:</p>
                        <p id="deduction-target-display" class="text-6xl font-black mt-1 tracking-tight"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-medium opacity-80">Beurten over:</p>
                        <p id="deduction-turns-display" class="text-5xl font-black mt-1 tracking-tight"></p>
                    </div>
                </div>

                <!-- Map Input -->
                <div class="mt-6 space-y-4">
                    <p id="deduction-location-label" class="text-center text-sm font-semibold text-gray-700">Klik op de kaart om een locatie te kiezen.</p>
                    <div class="map-wrapper">
                        <canvas id="deduction-map-canvas"></canvas>
                    </div>
                    <button id="deduction-submit-button" class="w-full button-primary text-white p-4 rounded-xl font-extrabold text-xl disabled:bg-gray-400 disabled:shadow-none disabled:transform-none" disabled>
                        Trek Temperatuur Af
                    </button>
                </div>

                <!-- Resultaat Beurt -->
                <div id="deduction-turn-result" class="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-md hidden transition-all duration-300"></div>
                
                <!-- Geschiedenis Log -->
                <div id="deduction-history-container" class="mt-8 pt-4 border-t border-gray-300">
                    <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                        <span class="mr-2 text-xl">üìú</span> Historie van Worpen:
                    </h3>
                    <div id="deduction-history-log-container" class="bg-white rounded-xl border border-gray-300 shadow-inner p-4">
                        <ul id="deduction-history-log" class="space-y-3">
                            <!-- Geschiedenis items komen hier -->
                        </ul>
                        <p id="deduction-history-placeholder" class="text-sm text-gray-500">Nog geen locaties gekozen.</p>
                    </div>
                </div>

            </div>
            
            <!-- Eindscherm -->
            <div id="deduction-end-screen" class="hidden text-center p-10 rounded-xl bg-white border-4 border-dashed border-gray-300">
                <h2 id="deduction-end-title" class="text-4xl font-black mb-4"></h2>
                <p id="deduction-end-message" class="text-xl mb-8 text-gray-700"></p>
                <button onclick="initializeDeductionGame()" class="bg-purple-600 text-white p-3 px-6 rounded-full font-bold text-lg hover:bg-purple-700 transition duration-150 shadow-xl">
                    Nieuw Spel Starten
                </button>
            </div>
        </div>
        
        <!-- Game 2: Temperatuur Raden -->
        <div id="guessing-game" class="hidden">
            <h1 class="text-4xl font-black text-center text-gray-900 mb-8">
                Temperatuur Raden
            </h1>
            
            <div id="guessing-game-board" class="space-y-6 hidden">
                
                <div class="p-4 bg-teal-50 rounded-xl border-2 border-teal-300 text-center shadow-inner">
                    <p class="text-base font-medium text-teal-800 flex items-center justify-center">
                        <span class="mr-2 text-xl">‚ùì</span> DOEL: Raad het geheime getal tussen 5 en 30 binnen 7 beurten.
                    </p>
                    <p id="guessing-guess-warning" class="text-sm mt-1 font-bold text-teal-600">
                        De temperatuur van de gekozen locatie is je gok.
                    </p>
                </div>

                <!-- Score Display -->
                <div class="score-panel flex justify-between items-center p-6 text-white rounded-xl shadow-2xl transition duration-300">
                    <div>
                        <p class="text-lg font-medium opacity-80">Geheim Getal:</p>
                        <p id="guessing-target-display" class="text-6xl font-black mt-1 tracking-tight">??</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-medium opacity-80">Gokken over:</p>
                        <p id="guessing-turns-display" class="text-5xl font-black mt-1 tracking-tight"></p>
                    </div>
                </div>

                <!-- Map Input -->
                <div class="mt-6 space-y-4">
                    <p id="guessing-location-label" class="text-center text-sm font-semibold text-gray-700">Klik op de kaart om een locatie te kiezen.</p>
                    <div class="map-wrapper">
                        <canvas id="guessing-map-canvas"></canvas>
                    </div>
                    <button id="guessing-submit-button" class="w-full button-primary text-white p-4 rounded-xl font-extrabold text-xl disabled:bg-gray-400 disabled:shadow-none disabled:transform-none" disabled>
                        Controleer Temperatuur
                    </button>
                </div>

                <!-- Resultaat Beurt -->
                <div id="guessing-turn-result" class="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-md hidden transition-all duration-300"></div>
                
                <!-- Historie Raden -->
                <div id="guessing-history-container" class="mt-8 pt-4 border-t border-gray-300">
                    <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                        <span class="mr-2 text-xl">üßê</span> Eerdere Gokken:
                    </h3>
                    <div id="guessing-history-log-container" class="bg-white rounded-xl border border-gray-300 shadow-inner p-4">
                        <ul id="guessing-history-log" class="space-y-3">
                            <!-- Geschiedenis items komen hier -->
                        </ul>
                        <p id="guessing-history-placeholder" class="text-sm text-gray-500">Nog geen gokken gedaan.</p>
                    </div>
                </div>

            </div>
            
            <!-- Eindscherm -->
            <div id="guessing-end-screen" class="hidden text-center p-10 rounded-xl bg-white border-4 border-dashed border-gray-300">
                <h2 id="guessing-end-title" class="text-4xl font-black mb-4"></h2>
                <p id="guessing-end-message" class="text-xl mb-8 text-gray-700"></p>
                <button onclick="initializeGuessingGame()" class="bg-purple-600 text-white p-3 px-6 rounded-full font-bold text-lg hover:bg-purple-700 transition duration-150 shadow-xl">
                    Nieuw Spel Starten
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- Configuratie & State ---
        // Jouw API-sleutel. Let op: deze is openbaar zichtbaar in de browser.
        const API_KEY = "b10dc274a5e56f6f6fc4fe68a7987217"; 
        const GEO_API_URL = "https://api.openweathermap.org/geo/1.0/reverse"; // Gebruiken voor LAT/LON -> Naam
        const FORECAST_API_URL = "https://api.openweathermap.org/data/2.5/forecast"; 

        const DEDUCTION_MAX_TURNS = 5;
        const GUESSING_MAX_TURNS = 7; 
        const GUESSING_MIN_TARGET = 5; 
        const GUESSING_MAX_TARGET = 30;

        // --- DEDUCTION GAME STATE ---
        let deductionTargetTemp = 0;
        let deductionTurnsLeft = DEDUCTION_MAX_TURNS;
        let deductionTurnHistory = []; 
        let deductionSelectedLocation = null; // NIEUW: {lat, lon, name, country}

        // --- GUESSING GAME STATE ---
        let guessingSecretNumber = 0; 
        let guessingTurnsLeft = GUESSING_MAX_TURNS;
        let guessingTurnHistory = []; 
        let guessingSelectedLocation = null;
        
        let gameActive = false;
        let currentView = 'menu';

        // --- DOM Elementen ---
        const mainMenu = document.getElementById('main-menu');
        const gameContainer = document.getElementById('game-container');
        const statusMessage = document.getElementById('status-message');
        const startGameButton = document.getElementById('startGameButton'); 
        const startGameGuessButton = document.getElementById('startGameGuessButton'); 

        // --- DEDUCTION DOM ---
        const deductionGame = document.getElementById('deduction-game');
        const deductionGameBoard = document.getElementById('deduction-game-board');
        const deductionEndScreen = document.getElementById('deduction-end-screen');
        const deductionTargetDisplay = document.getElementById('deduction-target-display');
        const deductionTurnsDisplay = document.getElementById('deduction-turns-display');
        const deductionSubmitButton = document.getElementById('deduction-submit-button');
        const deductionTurnResult = document.getElementById('deduction-turn-result');
        const deductionHistoryLog = document.getElementById('deduction-history-log');
        const deductionHistoryPlaceholder = document.getElementById('deduction-history-placeholder');
        const deductionMapCanvas = document.getElementById('deduction-map-canvas');
        const deductionLocationLabel = document.getElementById('deduction-location-label');

        // --- GUESSING DOM ---
        const guessingGame = document.getElementById('guessing-game');
        const guessingGameBoard = document.getElementById('guessing-game-board');
        const guessingEndScreen = document.getElementById('guessing-end-screen');
        const guessingTargetDisplay = document.getElementById('guessing-target-display');
        const guessingTurnsDisplay = document.getElementById('guessing-turns-display');
        const guessingSubmitButton = document.getElementById('guessing-submit-button');
        const guessingTurnResult = document.getElementById('guessing-turn-result');
        const guessingHistoryLog = document.getElementById('guessing-history-log');
        const guessingHistoryPlaceholder = document.getElementById('guessing-history-placeholder');
        const guessingMapCanvas = document.getElementById('guessing-map-canvas');
        const guessingLocationLabel = document.getElementById('guessing-location-label');


        // --- View Management ---
        function showView(viewName) {
            mainMenu.classList.add('hidden');
            gameContainer.classList.add('hidden');
            deductionGame.classList.add('hidden');
            guessingGame.classList.add('hidden');
            
            currentView = viewName;

            if (viewName === 'menu') {
                mainMenu.classList.remove('hidden');
                checkApiStatus(); 
            } else if (viewName === 'game') {
                gameContainer.classList.remove('hidden');
            }
        }

        // --- API & Core Functies ---

        /**
         * Gebruikt Reverse Geocoding om een naam te krijgen voor de gekozen LAT/LON.
         * Dit is optioneel, maar maakt de geschiedenis leesbaarder.
         * @param {number} lat
         * @param {number} lon
         * @returns {Promise<object>} {name, country}
         */
        async function reverseGeocode(lat, lon) {
            const geoParams = new URLSearchParams({
                lat: lat,
                lon: lon,
                limit: 1,
                appid: API_KEY,
            }).toString();

            try {
                const response = await fetch(`${GEO_API_URL}?${geoParams}`);
                const data = await response.json();
                
                if (data.length > 0 && data[0].name) {
                    const name = data[0].name;
                    const country = data[0].country || 'ONBEKEND';
                    
                    // Gebruik de offici√´le naam, of de co√∂rdinaten als fallback
                    const locationName = name.length > 18 ? `${lat.toFixed(2)}, ${lon.toFixed(2)}` : name;
                    
                    return { name: locationName, country: country };
                }
            } catch (error) {
                console.warn("Reverse Geocoding mislukt, gebruikt co√∂rdinaten als naam.");
            }
            // Fallback als de API faalt of geen stad vindt (bv. in de oceaan)
            return { name: `Locatie (${lat.toFixed(2)}, ${lon.toFixed(2)})`, country: 'OCEAN' };
        }


        /**
         * Haalt de GEMIDDELDE temperatuur op voor de geselecteerde co√∂rdinaten.
         * @param {object} locationData - Bevat lat, lon.
         * @param {HTMLElement} resultElement - Element om fouten in te tonen.
         * @returns {Promise<number|null>}
         */
        async function fetchTemperature(locationData, resultElement) {
            const forecastParams = new URLSearchParams({
                lat: locationData.lat, lon: locationData.lon, appid: API_KEY, units: 'metric'
            }).toString();

            try {
                const forecastResponse = await fetch(`${FORECAST_API_URL}?${forecastParams}`);
                const forecastData = await forecastResponse.json();

                if (forecastResponse.status !== 200) {
                    resultElement.innerHTML = `<span class="text-red-500 font-medium">‚ùå Fout (${forecastResponse.status}): Kon voorspellingsdata niet ophalen.</span>`;
                    return null;
                }
                
                // --- BEREKEN HET GEMIDDELDE VAN DE DAG ---
                let totalTemp = 0;
                let count = 0;
                let firstAvailableDate = null;
                
                if (forecastData.list && forecastData.list.length > 0) {
                    firstAvailableDate = forecastData.list[0].dt_txt.slice(0, 10);
                } else {
                     resultElement.innerHTML = `<span class="text-red-500 font-medium">‚ùå Fout: Geen voorspellingslijst beschikbaar.</span>`;
                     return null;
                }

                for (const item of forecastData.list) {
                    if (item.dt_txt.startsWith(firstAvailableDate)) {
                        totalTemp += item.main.temp;
                        count++;
                    }
                }

                if (count === 0) {
                    resultElement.innerHTML = `<span class="text-red-500 font-medium">‚ùå Fout: Kon geen temperatuurmetingen vinden voor de dichtstbijzijnde dag.</span>`;
                    return null;
                }

                const averageTemp = totalTemp / count;
                const roundedTemp = Math.round(averageTemp); 
                
                return roundedTemp;

            } catch (error) {
                resultElement.innerHTML = `<span class="text-red-500 font-medium">‚ùå Algemene Netwerkfout bij ophalen data.</span>`;
                return null;
            }
        }

        // --- Map Functies ---

        function drawMap(canvas) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            // Zorg ervoor dat de kaart de juiste grootte heeft voor responsiviteit
            canvas.style.width = '100%';
            canvas.style.height = '100%';

            // Teken een zeer simpele wereldkaart (om een idee van locatie te geven)
            ctx.fillStyle = '#a0c4ff'; // Oceaan
            ctx.fillRect(0, 0, w, h);

            ctx.fillStyle = '#4caf50'; // Land (vereenvoudigd)
            // Simpele landmassa's
            ctx.fillRect(w * 0.1, h * 0.2, w * 0.3, h * 0.6); // Amerika's
            ctx.fillRect(w * 0.5, h * 0.2, w * 0.4, h * 0.5); // Eurazi√´
            ctx.fillRect(w * 0.6, h * 0.7, w * 0.15, h * 0.15); // Australi√´

            // Teken evenaar en Greenwich meridiaan (hulplijnen)
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, h / 2); // Evenaar
            ctx.lineTo(w, h / 2);
            ctx.moveTo(w / 2, 0); // Meridiaan
            ctx.lineTo(w / 2, h);
            ctx.stroke();
        }

        function getLatLonFromClick(event, canvas) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Conversie van pixelco√∂rdinaten naar LAT/LON
            const lon = (x / canvas.width) * 360 - 180; // Breedte: -180 tot 180
            const lat = 90 - (y / canvas.height) * 180; // Lengte: 90 (boven) tot -90 (onder)

            return { lat: lat, lon: lon };
        }

        function handleMapClick(event, gameType) {
            let canvas, submitBtn, locationLabel;
            
            if (gameType === 'deduction') {
                canvas = deductionMapCanvas;
                submitBtn = deductionSubmitButton;
                locationLabel = deductionLocationLabel;
            } else {
                canvas = guessingMapCanvas;
                submitBtn = guessingSubmitButton;
                locationLabel = guessingLocationLabel;
            }

            const { lat, lon } = getLatLonFromClick(event, canvas);

            // Teken de kaart opnieuw en markeer de gekozen plek
            drawMap(canvas);
            const ctx = canvas.getContext('2d');
            
            // Teken de 'dartpijl' (rode stip)
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(event.offsetX, event.offsetY, 5, 0, Math.PI * 2);
            ctx.fill();

            // Sla de geselecteerde locatie op
            const locationData = { lat, lon };

            if (gameType === 'deduction') {
                deductionSelectedLocation = locationData;
            } else {
                guessingSelectedLocation = locationData;
            }

            // Update de UI
            locationLabel.textContent = `Gekozen: LAT ${lat.toFixed(2)}¬∞, LON ${lon.toFixed(2)}¬∞`;
            submitBtn.disabled = false;
        }

        // --- Status Management ---

        async function testApiConnection() {
            // Logica ongewijzigd
            statusMessage.textContent = "üî¨ API-verbinding testen met OpenWeatherMap...";
            statusMessage.className = "text-center p-3 mt-8 rounded-lg font-semibold bg-blue-100 text-blue-700";

            const testParams = new URLSearchParams({ q: "London", limit: 1, appid: API_KEY, }).toString();

            try {
                const response = await fetch(`${GEO_API_URL.replace('/reverse', '/direct')}?${testParams}`); // Gebruik /direct voor testen
                
                if (response.status === 200) {
                    statusMessage.textContent = "‚úÖ API-sleutel is geldig en actief. Kies een spel!";
                    statusMessage.className = "text-center p-3 mt-8 rounded-lg font-semibold bg-green-100 text-green-700";
                    return true;
                } else {
                    statusMessage.textContent = "‚ùå FOUT (401/Netwerk): API-sleutel ongeldig of niet actief. Spellen vereisen live data.";
                    statusMessage.className = "text-center p-3 mt-8 rounded-lg font-semibold bg-red-100 text-red-700 pulse";
                    return false;
                }
            } catch (error) {
                statusMessage.textContent = "‚ùå Netwerkfout: Kan geen verbinding maken met de API-service.";
                statusMessage.className = "text-center p-3 mt-8 rounded-lg font-semibold bg-red-100 text-red-700";
                return false;
            }
        }
        
        async function checkApiStatus() {
            mainMenu.classList.remove('hidden');
            const success = await testApiConnection();

            if (success) {
                startGameButton.disabled = false;
                startGameGuessButton.disabled = false;
            } else {
                startGameButton.disabled = true;
                startGameGuessButton.disabled = true;
            }
        }

        async function checkApiAndStart(gameType) {
            const apiIsActive = statusMessage.classList.contains('bg-green-100');
            
            if (apiIsActive || await testApiConnection()) {
                showView('game');
                if (gameType === 'deduction') {
                    deductionGame.classList.remove('hidden');
                    currentView = 'deduction';
                    initializeDeductionGame();
                } else if (gameType === 'guessing') {
                    guessingGame.classList.remove('hidden');
                    currentView = 'guessing';
                    initializeGuessingGame();
                }
            }
        }


        // **********************************************
        // ********** DEDUCTION GAME LOGIC **************
        // **********************************************

        function updateDeductionDisplay() {
            deductionTargetDisplay.textContent = `${deductionTargetTemp.toFixed(0)}¬∞C`;
            deductionTurnsDisplay.textContent = `${deductionTurnsLeft}/${DEDUCTION_MAX_TURNS}`;

            if (deductionTargetTemp < 0) {
                deductionTargetDisplay.classList.add('text-red-400');
            } else {
                deductionTargetDisplay.classList.remove('text-red-400');
            }
        }

        async function renderDeductionHistory() {
            deductionHistoryLog.innerHTML = ''; 
            if (deductionTurnHistory.length === 0) {
                deductionHistoryPlaceholder.classList.remove('hidden');
                return;
            }
            deductionHistoryPlaceholder.classList.add('hidden');

            deductionTurnHistory.slice().reverse().forEach((turn, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-700 text-sm flex justify-between items-center p-2 rounded-lg transition duration-100 bg-gray-50 hover:bg-gray-100 border-l-4 border-red-400';
                
                listItem.innerHTML = `
                    <span class="font-bold text-blue-700 mr-2">Worp ${DEDUCTION_MAX_TURNS - deductionTurnsLeft - index}:</span>
                    <span>${turn.name} (${turn.country})</span>
                    <span class="font-black text-red-600">${turn.temp}¬∞C</span>
                `;
                deductionHistoryLog.appendChild(listItem);
            });
        }

        function initializeDeductionGame() {
            deductionTargetTemp = Math.floor(Math.random() * 101) + 50; 
            deductionTurnsLeft = DEDUCTION_MAX_TURNS;
            gameActive = true;
            deductionTurnHistory = []; 
            deductionSelectedLocation = null; 
            
            deductionLocationLabel.textContent = 'Klik op de kaart om een locatie te kiezen.';
            deductionSubmitButton.disabled = true; 
            deductionSubmitButton.textContent = "Trek Temperatuur Af";

            updateDeductionDisplay(); 
            renderDeductionHistory(); 

            deductionGameBoard.classList.remove('hidden'); 
            deductionEndScreen.classList.add('hidden');
            
            // Kaart initialiseren en event listener toevoegen
            deductionMapCanvas.width = deductionMapCanvas.offsetWidth;
            deductionMapCanvas.height = deductionMapCanvas.offsetWidth / 2;
            drawMap(deductionMapCanvas);
            deductionMapCanvas.onclick = (e) => handleMapClick(e, 'deduction');
        }

        async function handleDeductionTurn() {
            if (!gameActive || deductionTurnsLeft === 0 || !deductionSelectedLocation) return;
            
            const { lat, lon } = deductionSelectedLocation;
            
            // 1. Controleer op duplicaten (gebaseerd op LAT/LON afgerond)
            const keyToCheck = `${lat.toFixed(2)},${lon.toFixed(2)}`;
            const isDuplicate = deductionTurnHistory.some(turn => `${turn.lat.toFixed(2)},${turn.lon.toFixed(2)}` === keyToCheck);

            if (isDuplicate) {
                deductionTurnResult.innerHTML = `<span class="text-red-600 font-medium">‚ùå Fout: Deze co√∂rdinaat (${keyToCheck}) is al gegokt. Kies een nieuwe plek!</span>`;
                deductionTurnResult.classList.remove('hidden');
                deductionSelectedLocation = null; 
                deductionSubmitButton.disabled = true;
                return;
            }
            
            // 2. Haal temperatuur op
            const temperature = await fetchTemperature(deductionSelectedLocation, deductionTurnResult);
            
            if (temperature === null) {
                deductionSubmitButton.disabled = true; 
                return; 
            }
            
            // 3. Haal naam op voor geschiedenis
            const geoInfo = await reverseGeocode(lat, lon);
            
            // --- Succesvolle GOK ---
            const oldTarget = deductionTargetTemp;
            deductionTargetTemp -= temperature; 
            deductionTurnsLeft--; 

            deductionTurnHistory.push({ 
                name: geoInfo.name, 
                country: geoInfo.country, 
                temp: temperature,
                lat: lat,
                lon: lon
            });
            
            deductionTurnResult.innerHTML = `
                <p class="text-sm text-gray-700 font-medium">Afgetrokken (Daggemiddelde van ${geoInfo.name}): ${temperature.toFixed(0)}¬∞C</p>
                <p class="text-sm text-gray-700 mt-1">Nieuw Doel: ${oldTarget.toFixed(0)}¬∞C - ${temperature.toFixed(0)}¬∞C = <span class="font-bold text-xl text-blue-700">${deductionTargetTemp.toFixed(0)}¬∞C</span></p>
            `;
            
            // UI en status reset
            deductionSelectedLocation = null; 
            deductionSubmitButton.disabled = true; 
            deductionLocationLabel.textContent = 'Klik op de kaart om een locatie te kiezen.';
            drawMap(deductionMapCanvas); // Kaart resetten

            updateDeductionDisplay();
            renderDeductionHistory(); 

            if (deductionTargetTemp <= 0 || deductionTurnsLeft === 0) {
                endDeductionGame();
            }
        }

        function endDeductionGame() {
            gameActive = false;
            deductionGameBoard.classList.add('hidden');
            deductionEndScreen.classList.remove('hidden');
            deductionTurnResult.classList.add('hidden');

            const score = deductionTargetTemp;
            
            if (score === 0) {
                document.getElementById('deduction-end-title').textContent = "üèÜ PERFECTE SCORE! üèÜ";
                document.getElementById('deduction-end-title').className = "text-4xl font-black mb-4 text-green-600";
                document.getElementById('deduction-end-message').textContent = "Je hebt precies 0¬∞C bereikt! Meesterlijke strategie!";
            } else if (score > 0) {
                document.getElementById('deduction-end-title').textContent = "Einde Spel!";
                document.getElementById('deduction-end-title').className = "text-4xl font-black mb-4 text-yellow-700";
                document.getElementById('deduction-end-message').textContent = `De beurten zijn op. Je bent ge√´indigd met ${score.toFixed(0)}¬∞C over. Score: ${score.toFixed(0)} punten.`;
            } else {
                document.getElementById('deduction-end-title').textContent = "üö® Over De Schreef! üö®";
                document.getElementById('deduction-end-title').className = "text-4xl font-black mb-4 text-red-600";
                document.getElementById('deduction-end-message').textContent = `Je hebt onder nul ge√´indigd met ${score.toFixed(0)}¬∞C. Probeer de volgende keer beter in te schatten.`;
            }
        }

        // **********************************************
        // ********** GUESSING GAME LOGIC ***************
        // **********************************************

        function updateGuessingDisplay() {
            guessingTurnsDisplay.textContent = `${guessingTurnsLeft}/${GUESSING_MAX_TURNS}`;
            // Toon het geheime nummer alleen als het spel voorbij is
            guessingTargetDisplay.textContent = gameActive ? "??" : `${guessingSecretNumber}¬∞C`;
            guessingTargetDisplay.classList.remove('text-green-600');
        }

        function renderGuessingHistory() {
            guessingHistoryLog.innerHTML = ''; 
            if (guessingTurnHistory.length === 0) {
                guessingHistoryPlaceholder.classList.remove('hidden');
                return;
            }
            guessingHistoryPlaceholder.classList.add('hidden');

            guessingTurnHistory.slice().reverse().forEach((turn, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-700 text-sm flex justify-between items-center p-2 rounded-lg transition duration-100 bg-gray-50 hover:bg-gray-100 border-l-4 ' + turn.color;
                
                listItem.innerHTML = `
                    <span class="font-bold text-gray-700 mr-2">Gok ${GUESSING_MAX_TURNS - guessingTurnsLeft - index}:</span>
                    <span>${turn.name} (${turn.country}): </span>
                    <span class="font-black ${turn.textColor}">${turn.guess}¬∞C (${turn.feedback})</span>
                `;
                guessingHistoryLog.appendChild(listItem);
            });
        }
        
        function initializeGuessingGame() {
            guessingSecretNumber = Math.floor(Math.random() * (GUESSING_MAX_TARGET - GUESSING_MIN_TARGET + 1)) + GUESSING_MIN_TARGET;
            guessingTurnsLeft = GUESSING_MAX_TURNS;
            gameActive = true;
            guessingTurnHistory = []; 
            guessingSelectedLocation = null; 
            
            guessingLocationLabel.textContent = 'Klik op de kaart om een locatie te kiezen.';
            guessingSubmitButton.disabled = true; 
            guessingSubmitButton.textContent = "Controleer Temperatuur";

            updateGuessingDisplay(); 
            renderGuessingHistory(); 

            guessingGameBoard.classList.remove('hidden'); 
            guessingEndScreen.classList.add('hidden');

            // Kaart initialiseren en event listener toevoegen
            guessingMapCanvas.width = guessingMapCanvas.offsetWidth;
            guessingMapCanvas.height = guessingMapCanvas.offsetWidth / 2;
            drawMap(guessingMapCanvas);
            guessingMapCanvas.onclick = (e) => handleMapClick(e, 'guessing');
        }

        async function handleGuessingTurn() {
            if (!gameActive || guessingTurnsLeft === 0 || !guessingSelectedLocation) return;
            
            const { lat, lon } = guessingSelectedLocation;

            // 1. Haal temperatuur op
            const temperature = await fetchTemperature(guessingSelectedLocation, guessingTurnResult);
            
            if (temperature === null) {
                guessingSubmitButton.disabled = true; 
                return; 
            }

            // 2. Haal naam op voor geschiedenis
            const geoInfo = await reverseGeocode(lat, lon);

            const guess = temperature;
            let feedback = '';
            let color = 'border-red-500';
            let textColor = 'text-red-600';
            
            if (guess === guessingSecretNumber) {
                feedback = 'GEWONNEN!';
                color = 'border-green-500';
                textColor = 'text-green-600';
                gameActive = false;
            } else if (guess < guessingSecretNumber) {
                feedback = 'HOGER';
                color = 'border-yellow-500';
                textColor = 'text-yellow-600';
            } else {
                feedback = 'LAGER';
                color = 'border-blue-500';
                textColor = 'text-blue-600';
            }

            guessingTurnsLeft--; 

            guessingTurnHistory.push({ 
                name: geoInfo.name, country: geoInfo.country, 
                guess: guess, feedback: feedback, color: color, textColor: textColor,
                lat: lat, lon: lon
            });
            
            guessingTurnResult.innerHTML = `
                <p class="text-sm text-gray-700 font-medium">Temperatuur van ${geoInfo.name}: <span class="font-bold ${textColor}">${guess}¬∞C</span></p>
                <p class="text-sm text-gray-700 mt-1">Feedback: Het geheime getal is <span class="font-bold text-lg ${textColor}">${feedback}</span>.</p>
            `;
            
            // UI en status reset
            guessingSelectedLocation = null; 
            guessingSubmitButton.disabled = true; 
            guessingLocationLabel.textContent = 'Klik op de kaart om een locatie te kiezen.';
            drawMap(guessingMapCanvas); // Kaart resetten

            updateGuessingDisplay();
            renderGuessingHistory(); 

            if (!gameActive || guessingTurnsLeft === 0) {
                endGuessingGame(guess === guessingSecretNumber);
            }
        }

        function endGuessingGame(won) {
            gameActive = false;
            guessingGameBoard.classList.add('hidden');
            guessingEndScreen.classList.remove('hidden');
            guessingTurnResult.classList.add('hidden');

            const titleElement = document.getElementById('guessing-end-title');
            const messageElement = document.getElementById('guessing-end-message');
            
            if (won) {
                titleElement.textContent = "ü•≥ GEVONDEN! ü•≥";
                titleElement.className = "text-4xl font-black mb-4 text-green-600";
                messageElement.textContent = `Je hebt het geheime nummer (${guessingSecretNumber}) geraden in ${GUESSING_MAX_TURNS - guessingTurnsLeft} gokken!`;
            } else {
                titleElement.textContent = "‚ùå GAME OVER ‚ùå";
                titleElement.className = "text-4xl font-black mb-4 text-red-600";
                messageElement.textContent = `Je beurten zijn op. Het geheime nummer was ${guessingSecretNumber}.`;
            }
            
            // Toon het geheime nummer in het scorepaneel
            guessingTargetDisplay.textContent = `${guessingSecretNumber}¬∞C`;
            if (won) guessingTargetDisplay.classList.add('text-green-600');
        }

        // --- Event Listeners Init ---
        
        // Deduction Game Listeners
        deductionSubmitButton.addEventListener('click', handleDeductionTurn);
        
        // Guessing Game Listeners
        guessingSubmitButton.addEventListener('click', handleGuessingTurn);

        // Start de initi√´le API-controle bij het laden van de pagina
        window.onload = checkApiStatus;

    </script>
</body>
</html>